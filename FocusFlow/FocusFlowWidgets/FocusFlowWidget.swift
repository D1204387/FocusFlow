import WidgetKit
import SwiftUI
import AppIntents

    // MARK: - Widget ‰∏ªË¶ÅË≥áÊñôÁµêÊßãËàá Provider
    // RunSummaryEntry: Ë∑ëÊ≠•ÊëòË¶ÅË≥áÊñô
    // RunSummaryProvider: Êèê‰æõ Widget Timeline Ë≥áÊñô
    // FocusFlowWidgetEntryView: Ê†πÊìö Widget Â§ßÂ∞èÈ°ØÁ§∫‰∏çÂêåÂÖßÂÆπ

struct RunSummaryEntry: TimelineEntry {
    let date: Date
    let phase: RunningState.Phase
    let weeklyMinutes: Int
    let streakDays: Int
    let todayMinutes: Int
}

struct RunSummaryProvider: TimelineProvider {
    func placeholder(in context: Context) -> RunSummaryEntry {
        .init(date: .now, phase: .idle, weeklyMinutes: 0, streakDays: 0, todayMinutes: 0)
    }
    func getSnapshot(in context: Context, completion: @escaping (RunSummaryEntry) -> Void) {
        completion(loadEntry())
    }
    func getTimeline(in context: Context, completion: @escaping (Timeline<RunSummaryEntry>) -> Void) {
        let entry = loadEntry()
        
            // ‚úÖ ‰øÆÊ≠£ÔºöÊ†πÊìöÁãÄÊÖãË™øÊï¥Êõ¥Êñ∞È†ªÁéá
        let updateInterval: TimeInterval
        switch entry.phase {
        case .running:
            updateInterval = 10 // Ë∑ëÊ≠•‰∏≠ÊØè 10 ÁßíÊõ¥Êñ∞
        case .paused:
            updateInterval = 30 // Êö´ÂÅúÊôÇÊØè 30 ÁßíÊõ¥Êñ∞
        case .idle:
            updateInterval = 300 // ÂæÖÊ©üÊôÇÊØè 5 ÂàÜÈêòÊõ¥Êñ∞
        }
        
        let nextUpdate = Calendar.current.date(
            byAdding: .second,
            value: Int(updateInterval),
            to: Date()) ?? Date()
        
        completion(Timeline(entries: [entry], policy: .after(nextUpdate)))
    }
    private func loadEntry() -> RunSummaryEntry {
        
        let userDefaults = UserDefaults(suiteName: "group.com.buildwithharry.focusflow")
        
        var phase: RunningState.Phase = .idle
        if let phaseData = userDefaults?.data(forKey: "currentRunningPhase"),
           let decodedPhase = try? JSONDecoder().decode(
            RunningState.Phase.self,
            from: phaseData) {
            phase = decodedPhase
        }
        
        let todayMinutes = userDefaults?.integer(forKey: "todayMinutes") ?? 0
        let weeklyMinutes = userDefaults?.integer(forKey: "weekRunMinutes") ?? 0
        let streakDays = userDefaults?.integer(forKey: "streakDays") ?? 0
        
            // ‚úÖ Èô§ÈåØÔºöÂç∞Âá∫ËÆÄÂèñÁöÑË≥áÊñô
        print("üìä Widget ËºâÂÖ•Ë≥áÊñô:")
        print("  Phase: \(phase)")
        print("  Today: \(todayMinutes) ÂàÜ")
        print("  Weekly: \(weeklyMinutes) ÂàÜ")
        print("  Streak: \(streakDays) Â§©")
        
        return .init(
            date: .now,
            phase: phase,
            weeklyMinutes: weeklyMinutes,
            streakDays: streakDays,
            todayMinutes: todayMinutes
        )
    }
}

    // MARK: - Small/Medium Widget Áï´Èù¢
struct FocusFlowWidgetEntryView: View {
    let entry: RunSummaryEntry
    @Environment(\.widgetFamily) private var family
    
    var body: some View {
        switch family {
        case .systemSmall: smallView
        default: mediumView
        }
    }
    
        // MARK: - Small
    private var smallView: some View {
        VStack(alignment: .leading, spacing: 6) {
            HStack(spacing: 6) {
                Image(systemName: "figure.run.circle.fill")
                    .font(.caption)
                    .foregroundStyle(.blue)
                Text("Ë∑ëÊ≠•Áµ±Ë®à")
                    .font(.caption2)
                    .fontWeight(.medium)
                    .foregroundStyle(.primary)
                
                Spacer()
                
                    // ‚úÖ Êñ∞Â¢ûÔºöÈáçÊñ∞Êï¥ÁêÜÊåâÈàï
                Button(intent: RefreshWidgetIntent()) {
                    Image(systemName: "arrow.clockwise")
                        .font(.caption2)
                        .foregroundStyle(.secondary)
                }
                .buttonStyle(.plain)
                
                    // Status indicator
                Circle()
                    .fill(phaseColor)
                    .frame(width: 5, height: 5)
            }
                // Status text
            Text(statusText)
                .font(.caption2)
                .fontWeight(.medium)
                .foregroundStyle(phaseColor)
                .padding(.horizontal, 4)
                .padding(.vertical, 1)
                .background(phaseColor.opacity(0.1), in: Capsule())
            
            Spacer(minLength: 2)
            
            // Stats
            VStack(alignment: .leading, spacing: 3) {
                StatRow(icon: "clock.fill", label: "‰ªäÊó•", value: "\(entry.todayMinutes)", unit: "ÂàÜ")
                StatRow(icon: "calendar", label: "Êú¨ÈÄ±", value: "\(entry.weeklyMinutes)", unit: "ÂàÜ")
                StatRow(icon: "flame.fill", label: "ÈÄ£Á∫å", value: "\(entry.streakDays)", unit: "Â§©")
            }
            
            Spacer(minLength: 0)
        }
        .padding(8)
        .containerBackground(.regularMaterial, for: .widget)
    }
    
        // MARK: - Medium
    private var mediumView: some View {
        HStack(spacing: 10) {
            VStack(alignment: .leading, spacing: 6) {
                HStack(spacing: 6) {
                    Image(systemName: "figure.run.circle.fill")
                        .font(.title3)
                        .foregroundStyle(.blue)
                    
                    VStack(alignment: .leading, spacing: 1) {
                        Text("Ë∑ëÊ≠•Áµ±Ë®à")
                            .font(.subheadline)
                            .fontWeight(.semibold)
                        
                        HStack(spacing: 4) {
                            Circle()
                                .fill(phaseColor)
                                .frame(width: 4, height: 4)
                            
                            Text(statusText)
                                .font(.caption2)
                                .foregroundStyle(phaseColor)
                        }
                    }
                    
                    Spacer()
                        // ‚úÖ Êñ∞Â¢ûÔºöÈáçÊñ∞Êï¥ÁêÜÊåâÈàï
                    Button(intent: RefreshWidgetIntent()) {
                        Image(systemName: "arrow.clockwise")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                    }
                    .buttonStyle(.plain)
                }
                Text(subtitleText)
                    .font(.caption2)
                    .foregroundStyle(.secondary)
                    .lineLimit(1)
                
                Spacer()
                
                VStack(alignment: .leading, spacing: 4) {
                    Text("‰ªäÊó•Ë°®Áèæ")
                        .font(.caption2)
                        .fontWeight(.medium)
                        .foregroundStyle(.secondary)
                    
                    HStack(spacing: 4) {
                        Image(systemName: "clock.fill")
                            .font(.caption2)
                            .foregroundStyle(.blue)
                        
                        Text("\(entry.todayMinutes) ÂàÜ")
                            .font(.callout)
                            .fontWeight(.semibold)
                            .monospacedDigit()
                    }
                }
                .padding(8)
                .background(.regularMaterial, in: RoundedRectangle(cornerRadius: 8))
            }
            
            // Âç°Áâá
            VStack(spacing: 6) {
                VStack(alignment: .leading, spacing: 3) {
                    HStack(spacing: 3) {
                        Image(systemName: "calendar")
                            .font(.caption2)
                            .foregroundStyle(.blue)
                        Text("Êú¨ÈÄ±")
                            .font(.caption2)
                            .foregroundStyle(.secondary)
                    }
                
                    Text("\(entry.weeklyMinutes)")
                        .font(.title3)
                        .fontWeight(.bold)
                        .monospacedDigit()
                    
                    Text("ÂàÜÈêò")
                        .font(.caption2)
                        .foregroundStyle(.secondary)
                }
                .frame(maxWidth: .infinity, alignment: .leading)
                .padding(6)
                .background(.regularMaterial, in: RoundedRectangle(cornerRadius: 6))
                        
                 VStack(alignment: .leading, spacing: 3) {
                    HStack(spacing: 3) {
                        Image(systemName: "flame.fill")
                            .font(.caption2)
                            .foregroundStyle(.orange)
                        Text("ÈÄ£Á∫å")
                            .font(.caption2)
                            .foregroundStyle(.secondary)
                    }
                    
                    Text("\(entry.streakDays)")
                        .font(.title3)
                        .fontWeight(.bold)
                        .monospacedDigit()
                    
                    Text("Â§©")
                        .font(.caption2)
                        .foregroundStyle(.secondary)
                }
                .frame(maxWidth: .infinity, alignment: .leading)
                .padding(6)
                .background(.regularMaterial, in: RoundedRectangle(cornerRadius: 6))
            }
            .frame(width: 70)
        }
        .padding(10)
        .containerBackground(.regularMaterial, for: .widget)
    }
                  
    private struct StatRow: View {
        let icon: String
        let label: String
        let value: String
        let unit: String
        
        var body: some View {
            HStack(spacing: 4) {
                Image(systemName: icon)
                    .font(.caption)
                    .foregroundStyle(.blue)
                    .frame(width: 10)
                
                Text(label)
                    .font(.caption2)
                    .foregroundStyle(.secondary)
                
                Spacer()
                
                HStack(spacing: 1) {
                    Text(value)
                        .font(.caption2)
                        .fontWeight(.medium)
                        .monospacedDigit()
                    Text(unit)
                        .font(.caption2)
                        .foregroundStyle(.secondary)
                }
            }
        }
    }
    
        // ÊñáÂ≠óËàáÈ°èËâ≤
    private var statusText: String {
        switch entry.phase {
        case .running: "Ë∑ëÊ≠•‰∏≠"
        case .paused: "Êö´ÂÅú"
        case .idle: "ÂæÖÊ©ü"
        }
    }
    
    private var subtitleText: String {
        switch entry.phase {
        case .running: "‰øùÊåÅÈÖçÈÄüÔºÅ"
        case .paused:  "ÈªûÊåâÁπºÁ∫å"
        case .idle:    "ÈñãÂßãÈÅãÂãïÔºü"
        }
    }
    
    private var phaseColor: Color {
        switch entry.phase {
        case .running: .green
        case .paused: .orange
        case .idle: .blue
        }
    }
}

struct FocusFlowWidget: Widget {
    private let kind = "FocusFlowRunningSummary"
    
    var body: some WidgetConfiguration {
        StaticConfiguration(kind: kind, provider: RunSummaryProvider()) { entry in
            FocusFlowWidgetEntryView(entry: entry)
        }
        .configurationDisplayName("Ë∑ëÊ≠•Áµ±Ë®à")
        .description("È°ØÁ§∫Ë∑ëÊ≠•ÁãÄÊÖã„ÄÅ‰ªäÊó•ËàáÊú¨ÈÄ±Á¥ØÁ©çÊï∏Êìö„ÄÇ")
        .supportedFamilies([.systemSmall, .systemMedium])
    }
}

    // MARK: - Previews
#Preview(as: .systemSmall) {
    FocusFlowWidget()
} timeline: {
    RunSummaryEntry(date: .now, phase: .running, weeklyMinutes: 42, streakDays: 3, todayMinutes: 10)
    RunSummaryEntry(date: .now, phase: .idle,    weeklyMinutes: 0,  streakDays: 0, todayMinutes: 0)
}

#Preview(as: .systemMedium) {
    FocusFlowWidget()
} timeline: {
    RunSummaryEntry(date: .now, phase: .paused,  weeklyMinutes: 18, streakDays: 5, todayMinutes: 5)
    RunSummaryEntry(date: .now, phase: .running, weeklyMinutes: 60, streakDays: 10, todayMinutes: 30)
}
