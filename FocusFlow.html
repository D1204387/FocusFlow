<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>FocusFlow Â· è·‘æ­¥ Ã— å°ˆæ³¨ Ã— éŠæˆ²åŒ–</title>
<style>
:root{
  --blue:#4a90ff;
  --blue-2:#6aa7ff;
  --bg:#f6f9ff;
  --card:rgba(255,255,255,.92);
  --stroke:rgba(255,255,255,.6);
  --shadow:0 10px 20px rgba(0,0,0,.06);
  --radius:18px;
  --text:#0f172a;
  --muted:#64748b;
  --green:#10b981;
  --orange:#f59e0b;
  --red:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  color:var(--text); background:linear-gradient(180deg,#eef6ff,#ffffff 45%,#eef6ff);
}
#app{
  min-height:100dvh; display:flex; flex-direction:column;
  padding-bottom:72px; /* é ç•™åº•éƒ¨åˆ†é åˆ—é«˜åº¦ */
}

/* header */
.header{
  padding:16px 16px 6px; text-align:center;
}
.header h1{ margin:.25rem 0 0; font-size:28px; color:var(--blue); }
.header .sub{ color:var(--muted); font-size:14px }

/* glass card */
.card{
  background:var(--card); border-radius:var(--radius);
  box-shadow:var(--shadow); border:1px solid var(--stroke);
  padding:14px; margin:10px 16px;
}

/* tip */
.tip-row{ display:flex; gap:12px; align-items:flex-start }
.tip-row .icon{ color:#facc15; font-size:20px }
.section-title{ display:flex; align-items:center; gap:8px; color:var(--text); font-weight:600; margin:14px 16px 8px }
.section-title .muted{ color:var(--muted); font-weight:500 }

/* time slider block */
.time-number{ font-size:44px; color:var(--blue); font-weight:800; text-align:center }
.time-unit{ color:var(--muted); text-align:center; margin-top:-4px }
.range-wrap{ padding:8px 0 6px }
input[type=range]{ width:100% }
.quick-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:8px }
.quick-btn{
  border-radius:12px; border:1px solid rgba(0,0,0,.08);
  background:#f3f4f6; padding:10px 8px; text-align:center; font-size:12px;
}
.quick-btn.active{
  outline:2px solid var(--blue); background:rgba(74,144,255,.08); color:var(--blue); font-weight:600;
}

/* music chips */
.music-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
.music-chip{
  border-radius:12px; padding:12px; border:1px solid rgba(0,0,0,.08);
  background:#fff; display:flex; gap:10px; align-items:center;
}
.music-chip.active{ outline:2px solid var(--blue); background:rgba(74,144,255,.06) }
.music-chip .emoji{ font-size:20px }
.music-chip .label{ font-weight:600 }
.music-chip .sub{ font-size:12px; color:var(--muted) }

/* CTA button */
.cta{
  position:fixed; left:16px; right:16px; bottom:86px; z-index:5;
}
.btn{
  width:100%; height:56px; border-radius:18px; border:0; cursor:pointer;
  background:linear-gradient(90deg,var(--blue),var(--blue-2));
  color:#fff; font-weight:800; font-size:16px; box-shadow:0 8px 18px rgba(74,144,255,.28);
}
.btn:disabled{ opacity:.6; cursor:not-allowed }

/* tabs */
.tabs{
  position:fixed; left:0; right:0; bottom:0; height:74px; z-index:4;
  background:rgba(255,255,255,.75); backdrop-filter:saturate(180%) blur(10px);
  border-top:1px solid rgba(0,0,0,.06); display:flex; align-items:center; justify-content:space-around;
}
.tab{ display:flex; flex-direction:column; align-items:center; font-size:12px; color:var(--muted); text-decoration:none }
.tab.active{ color:var(--blue); font-weight:700 }

/* screens */
.screen{ display:none; }
.screen.active{ display:block; }

/* running circle progress */
.progress-wrap{ display:grid; place-items:center; margin:8px 0 2px }
.ring{
  width:230px; height:230px; border-radius:50%;
  background:
    conic-gradient(var(--blue) calc(var(--p)*1%), #e5e7eb 0),
    radial-gradient(#fff 56%, transparent 57%); /* å…§ç™½å¤–ç° */
  transition:background .4s linear;
}
.ring .center{
  position:relative; width:230px; height:230px; display:grid; place-items:center;
}
.time-big{ position:absolute; text-align:center; }
.time-big .t{ font-size:40px; color:var(--blue); font-weight:900 }
.time-big .remain{ color:var(--muted); margin-top:4px }

/* controls row */
.controls{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:6px }
.btn-orange{ background:linear-gradient(90deg,#fb923c,#f59e0b) }
.btn-green{ background:linear-gradient(90deg,#10b981,#34d399) }
.btn-red{ background:linear-gradient(90deg,#ef4444,#f87171) }

/* completion modal */
.modal{
  position:fixed; inset:0; background:rgba(0,0,0,.18); display:none; align-items:center; justify-content:center;
}
.modal .box{
  width:min(92%,420px); background:#fff; border-radius:20px; padding:22px; text-align:center; box-shadow:var(--shadow);
}
.modal.show{ display:flex }
.check{ width:92px; height:92px; border-radius:50%; background:#22c55e; color:#fff; display:grid; place-items:center; font-size:48px; margin:6px auto 12px }

/* focus (pomodoro) */
.focus-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
.counter{ font-size:42px; font-weight:900; color:var(--blue); text-align:center }

/* records */
.summary-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px }
.pill{
  background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px; text-align:center
}
.pill .k{ font-size:12px; color:var(--muted) }
.pill .v{ font-size:16px; font-weight:800 }

.list{ display:flex; flex-direction:column; gap:10px }
.row{
  display:flex; gap:12px; align-items:flex-start;
}
.row .date{ width:64px }
.badge{ width:8px; height:8px; border-radius:50% }

/* game placeholder */
.game-box{ text-align:center; padding:16px }

/* helpers */
.hide{ display:none !important }
.m8{ margin:8px 16px }
</style>
</head>
<body>
<div id="app">

  <!-- Header -->
  <div class="header">
    <div style="font-size:26px">ğŸƒâ€â™‚ï¸ FocusFlow</div>
    <div class="sub">è¼•é¬†å®Œæˆè·‘æ­¥èˆ‡å°ˆæ³¨ Â· å®Œæˆå°±çµ¦ä½ ç©ä¸€å±€</div>
  </div>

  <!-- ===== Home/Running Screen ===== -->
  <section id="screen-run" class="screen active">

    <div class="card">
      <div class="tip-row">
        <div class="icon">ğŸ’¡</div>
        <div>
          <div style="color:var(--blue); font-weight:700">ä»Šæ—¥å°æç¤º</div>
          <div id="tip" style="color:var(--muted); font-size:14px">è¨˜å¾—èƒ½é‚Šè·‘é‚ŠèŠå¤©çš„ç¯€å¥</div>
        </div>
      </div>
    </div>

    <div class="section-title">â±ï¸ <span>é‹å‹•æ™‚é–“</span></div>
    <div class="card" id="timeCard">
      <div class="time-number"><span id="targetMin">30</span></div>
      <div class="time-unit">åˆ†é˜</div>
      <div class="range-wrap">
        <input id="range" type="range" min="1" max="60" step="1" value="30">
      </div>
      <div class="quick-grid">
        <button class="quick-btn" data-min="15">15åˆ†<br>è¼•é¬†</button>
        <button class="quick-btn active" data-min="30">30åˆ†<br>å‰›å¥½</button>
        <button class="quick-btn" data-min="45">45åˆ†<br>æŒ‘æˆ°</button>
        <button class="quick-btn" data-min="60">60åˆ†<br>å……åˆ†</button>
      </div>
    </div>

    <div class="section-title">ğŸµ <span>èƒŒæ™¯éŸ³å ´</span> <span class="muted">(éŸ³å ´æŸ”å’Œï¼‹ç¯€æ‹å™¨)</span></div>
    <div class="card">
      <div class="music-grid" id="musicGrid">
        <button class="music-chip active" data-kind="light">
          <div class="emoji">ğŸ¼</div>
          <div><div class="label">è¼•éŸ³æ¨‚</div><div class="sub">èˆ’ç·©æ—‹å¾‹</div></div>
        </button>
        <button class="music-chip" data-kind="nature">
          <div class="emoji">ğŸŒ¿</div>
          <div><div class="label">è‡ªç„¶éŸ³</div><div class="sub">æ£®æ—/æµ·æµª</div></div>
        </button>
      </div>
    </div>

    <div class="card">
      <div class="progress-wrap">
        <div class="ring" id="ring" style="--p:0">
          <div class="center">
            <div class="time-big">
              <div class="t" id="elapsed">0:00</div>
              <div class="remain" id="remain">å‰©é¤˜ 30:00</div>
              <div style="margin-top:6px; color:#f59e0b" id="percent">0%</div>
            </div>
          </div>
        </div>
      </div>
      <div class="controls">
        <button id="pauseBtn" class="btn btn-orange" disabled>â¸ æš«åœ</button>
        <button id="stopBtn" class="btn btn-red" disabled>â–  çµæŸ</button>
      </div>
    </div>

    <div class="cta"><button id="startBtn" class="btn">â–¶ï¸ é–‹å§‹è¶…æ…¢è·‘</button></div>
  </section>

  <!-- ===== Focus Screen ===== -->
  <section id="screen-focus" class="screen">
    <div class="section-title">ğŸ¯ <span>ç•ªèŒ„æ™‚é˜</span> <span class="muted">(é è¨­ 25 / 5)</span></div>

    <div class="card">
      <div class="focus-row">
        <div>
          <div class="k" style="color:var(--muted); margin-bottom:4px">å°ˆæ³¨ï¼ˆåˆ†ï¼‰</div>
          <input id="focusMin" type="range" min="10" max="60" value="25" />
          <div class="counter"><span id="focusMinText">25</span></div>
        </div>
        <div>
          <div class="k" style="color:var(--muted); margin-bottom:4px">ä¼‘æ¯ï¼ˆåˆ†ï¼‰</div>
          <input id="breakMin" type="range" min="3" max="20" value="5" />
          <div class="counter"><span id="breakMinText">5</span></div>
        </div>
      </div>
    </div>

    <div class="card" style="text-align:center">
      <div style="color:var(--muted)">ç•¶å‰éšæ®µ</div>
      <div style="font-size:20px; font-weight:800; margin:4px 0" id="phaseTitle">å°ˆæ³¨</div>
      <div class="counter" id="focusClock">25:00</div>
      <div class="controls" style="max-width:520px; margin:0 auto">
        <button id="fStart" class="btn btn-green">é–‹å§‹</button>
        <button id="fPause" class="btn btn-orange" disabled>æš«åœ</button>
      </div>
      <button id="fStop" class="btn btn-red" style="margin-top:10px" disabled>çµæŸ</button>
    </div>
  </section>

  <!-- ===== Records Screen ===== -->
  <section id="screen-records" class="screen">
    <div class="section-title">ğŸ“Š <span>è¿‘ 7 å¤©æ‘˜è¦</span></div>
    <div class="card">
      <div class="summary-grid" id="summaryGrid">
        <div class="pill"><div class="k">æ¬¡æ•¸</div><div class="v" id="sumRuns">0</div></div>
        <div class="pill"><div class="k">æ™‚é•·</div><div class="v" id="sumMins">0 åˆ†</div></div>
        <div class="pill"><div class="k">é”æ¨™</div><div class="v" id="sumMet">0 æ¬¡</div></div>
        <div class="pill"><div class="k">å¹³å‡å®Œæˆ</div><div class="v" id="avgPct">0%</div></div>
      </div>
      <div class="m8">
        <svg id="chart" viewBox="0 0 320 140" width="100%" height="140" aria-label="è¿‘ä¸ƒæ—¥åœ–è¡¨">
          <rect x="0" y="0" width="320" height="140" fill="#fff" rx="12"></rect>
          <!-- bars injected by JS -->
        </svg>
      </div>
    </div>

    <div class="section-title">ğŸ“ <span>é‹å‹•è©³æƒ…</span> <span class="muted" id="detailCount"></span></div>
    <div class="card">
      <div class="list" id="list"></div>
      <button id="clearAll" class="btn btn-red" style="margin-top:12px">æ¸…é™¤æ‰€æœ‰è¨˜éŒ„</button>
    </div>
  </section>

  <!-- ===== Game Screen ===== -->
  <section id="screen-game" class="screen">
    <div class="section-title">ğŸ•¹ï¸ <span>éŠæˆ²å€ï¼ˆçå‹µï¼‰</span></div>
    <div class="card game-box">
      <div>å®Œæˆä¸€æ¬¡è·‘æ­¥æˆ–ç•ªèŒ„ï¼Œå¯ç²å¾— <b>1 èƒ½é‡</b> ç”¨ä¾†ç©ä¸€å±€ 2048ã€‚</div>
      <div style="margin-top:8px">ç›®å‰èƒ½é‡ï¼š<b id="energy">0</b></div>
      <button id="play2048" class="btn" style="margin-top:16px">é–‹å§‹ 2048ï¼ˆæ¶ˆè€— 1ï¼‰</button>
      <div style="margin-top:10px; color:var(--muted)">ï¼ˆæ­¤é ç‚ºå ä½ï¼Œä¹‹å¾Œå¯ç½®æ›åŒå­¸çš„ 2048 æ¨¡çµ„ï¼‰</div>
    </div>
  </section>

  <!-- Tabs -->
  <nav class="tabs">
    <a class="tab active" data-tab="run">ğŸƒâ€â™‚ï¸<div>è·‘æ­¥</div></a>
    <a class="tab" data-tab="focus">ğŸ¯<div>å°ˆæ³¨</div></a>
    <a class="tab" data-tab="records">ğŸ“Š<div>è¨˜éŒ„</div></a>
    <a class="tab" data-tab="game">ğŸ•¹ï¸<div>éŠæˆ²</div></a>
  </nav>
</div>

<!-- Completion Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <div class="check">âœ“</div>
    <div style="color:var(--blue); font-weight:800; font-size:20px">å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†ä»Šå¤©çš„ç›®æ¨™</div>
    <div id="modalText" style="color:var(--muted); margin-top:6px">å·²ç´€éŒ„æ–¼è¿‘ 7 å¤©çµ±è¨ˆ</div>
    <button id="modalOK" class="btn" style="margin-top:14px">å®Œæˆ</button>
  </div>
</div>

<script>
/* ========= å°å·¥å…· ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function secToClock(s){
  s = Math.max(0, s|0);
  const m = Math.floor(s/60), ss = s%60;
  return `${m}:${ss.toString().padStart(2,'0')}`;
}
function fmtDate(d){
  const dt = new Date(d);
  return `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}`;
}
function fmtTime(d){
  const dt = new Date(d);
  return `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
}

/* ========= ç‹€æ…‹ ========= */
const State = {
  targetSeconds: 30*60,
  music: 'light',
  running: false,
  paused: false,
  current: 0, // elapsed
  timerId: null,
  tipPool: [
    "ç”¨èƒ½èŠå¤©çš„é€Ÿåº¦è·‘ï¼Œä¿æŒå¾®å–˜å³å¯ã€‚",
    "æ¯ 10 åˆ†é˜æ“ºå‹•è‚©é ¸ï¼Œæ”¾é¬†æ‰‹æŒã€‚",
    "é–‹è·‘å‰å…ˆèµ° 3 åˆ†é˜ç†±èº«ã€‚",
    "å‘¼å¸ç¯€å¥ï¼šé¼»å¸å£åï¼Œåˆ¥æ†‹æ°£ã€‚",
    "è…³æ­¥è¼•ã€æ­¥é »ç©©ï¼Œæ¯”è·¨å¤§æ­¥æ›´é‡è¦ã€‚",
    "å–å¹¾å£æ°´ï¼Œä¸è¦ä¸€æ¬¡çŒå¤ªå¤šã€‚",
    "å®Œè·‘å¾Œåš 2 åˆ†é˜æ‹‰ä¼¸ã€‚"
  ],
  energy: +localStorage.getItem('ff_energy') || 0,
  records: JSON.parse(localStorage.getItem('ff_records')||'[]') // {date, duration, target}
};

function saveRecords(){ localStorage.setItem('ff_records', JSON.stringify(State.records)); }
function saveEnergy(){ localStorage.setItem('ff_energy', String(State.energy)); }

/* ========= Tabs ========= */
$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const key = t.dataset.tab;
    $$('.screen').forEach(s=>s.classList.remove('active'));
    $('#screen-'+key).classList.add('active');
    if(key==='records') renderRecords();
  });
});

/* ========= åˆå§‹åŒ–æç¤º ========= */
function renderTip(){
  $('#tip').textContent = State.tipPool[Math.floor(Math.random()*State.tipPool.length)];
}
renderTip();

/* ========= é‹å‹•ï¼šUI ç¶å®š ========= */
const range = $('#range');
const targetMin = $('#targetMin');
function setTarget(min){
  min = Math.max(1, Math.min(60, min|0));
  range.value = min; targetMin.textContent = min;
  State.targetSeconds = min*60;
  $('#remain').textContent = `å‰©é¤˜ ${secToClock(State.targetSeconds - State.current)}`;
  $$('.quick-btn').forEach(b=>{
    b.classList.toggle('active', +b.dataset.min===min);
  });
  updateRing();
}
range.addEventListener('input', e=> setTarget(+e.target.value) );
$$('.quick-btn').forEach(b=> b.addEventListener('click', ()=> setTarget(+b.dataset.min)) );

$('#musicGrid').addEventListener('click', e=>{
  const btn = e.target.closest('.music-chip'); if(!btn) return;
  State.music = btn.dataset.kind;
  $$('#musicGrid .music-chip').forEach(x=>x.classList.toggle('active', x===btn));
});

/* ========= é‹å‹•ï¼šæ§åˆ¶ ========= */
const startBtn = $('#startBtn'), pauseBtn = $('#pauseBtn'), stopBtn = $('#stopBtn');
function updateControls(){
  startBtn.disabled = State.running;
  pauseBtn.disabled = !State.running;
  stopBtn.disabled = !State.running;
}
function updateRing(){
  const pct = Math.min(1, State.current / State.targetSeconds);
  $('#ring').style.setProperty('--p', (pct*100).toFixed(2));
  $('#elapsed').textContent = secToClock(State.current);
  $('#percent').textContent = `${Math.round(pct*100)}%`;
  const remain = Math.max(0, State.targetSeconds - State.current);
  $('#remain').textContent = `å‰©é¤˜ ${secToClock(remain)}`;
}

function tick(){
  if(!State.running) return;
  State.current += 1;
  updateRing();
  if(State.current >= State.targetSeconds){
    completeRun();
  }
}
function startRun(){
  if(State.running) return;
  State.running = true; State.paused = false;
  State.current = Math.min(State.current, State.targetSeconds);
  updateControls(); updateRing();
  State.timerId = setInterval(tick, 1000);
}
function pauseRun(){
  if(!State.running) return;
  State.running = false; State.paused = true;
  clearInterval(State.timerId); updateControls();
}
function stopRun(){
  if(!State.running && !State.paused) return;
  clearInterval(State.timerId);
  State.running = false; State.paused = false;
  if(State.current>0){
    addRecord(State.current, State.targetSeconds);
  }
  State.current = 0; updateControls(); updateRing();
}

function completeRun(){
  clearInterval(State.timerId);
  State.running = false; State.paused = false;
  addRecord(State.targetSeconds, State.targetSeconds);
  State.current = 0; updateControls(); updateRing();
  State.energy += 1; saveEnergy(); renderEnergy();
  showModal(`å®Œæˆ ${targetMin.textContent} åˆ†é˜ï¼Œç²å¾— 1 èƒ½é‡ï¼`);
}

startBtn.addEventListener('click', startRun);
pauseBtn.addEventListener('click', ()=> State.paused ? startRun() : (pauseRun(), pauseBtn.textContent='â–¶ï¸ ç¹¼çºŒ'));
pauseBtn.addEventListener('click', ()=> { if(State.running){ pauseBtn.textContent='â¸ æš«åœ' } });
stopBtn.addEventListener('click', stopRun);

/* ========= å®Œæˆå‹•ç•« ========= */
function showModal(text){
  $('#modalText').textContent = text || 'å·²ç´€éŒ„æ–¼è¿‘ 7 å¤©çµ±è¨ˆ';
  $('#modal').classList.add('show');
}
$('#modalOK').addEventListener('click', ()=> $('#modal').classList.remove('show'));

/* ========= è¨˜éŒ„å„²å­˜ & ç•«é¢ ========= */
function addRecord(durationSec, targetSec){
  const rec = { date: Date.now(), duration: durationSec, target: targetSec };
  State.records.unshift(rec);
  saveRecords();
}
function recordsLast7(){
  const now = new Date(); const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()-6).getTime();
  return State.records.filter(r=> r.date >= start);
}
function renderRecords(){
  const rec7 = recordsLast7();
  // æ‘˜è¦
  const runs = rec7.length;
  const mins = Math.round(rec7.reduce((a,r)=>a+r.duration,0)/60);
  const met  = rec7.filter(r=> r.duration>=r.target && r.target>0).length;
  const avg  = Math.round((rec7.reduce((a,r)=> a+Math.min(r.duration/r.target,1),0)/(rec7.length||1))*100);

  $('#sumRuns').textContent = runs;
  $('#sumMins').textContent = `${mins} åˆ†`;
  $('#sumMet').textContent  = `${met} æ¬¡`;
  $('#avgPct').textContent  = `${isFinite(avg)?avg:0}%`;
  $('#detailCount').textContent = `å…± ${rec7.length} ç­†`;

  // æ¸…å–®
  const list = $('#list'); list.innerHTML='';
  rec7.sort((a,b)=>b.date-a.date).forEach(r=>{
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `
      <div class="date">
        <div style="font-weight:700">${fmtDate(r.date)}</div>
        <div style="color:var(--muted); font-size:12px">${fmtTime(r.date)}</div>
      </div>
      <div style="flex:1">
        <div style="display:flex; align-items:center; gap:10px; justify-content:space-between; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:10px 12px;">
          <div>â± ${secToClock(r.duration)}</div>
          <div style="color:var(--muted); font-size:13px">å®Œæˆåº¦ ${Math.round(Math.min(r.duration/r.target,1)*100)}%</div>
          <div class="badge" style="background:${(r.duration>=r.target)?'#10b981':'#f59e0b'}"></div>
        </div>
      </div>`;
    list.appendChild(row);
  });

  // åœ–è¡¨
  drawChart(rec7);
}

function drawChart(rec7){
  const svg = $('#chart');
  // æ¸… bars
  [...svg.querySelectorAll('rect.bar'), ...svg.querySelectorAll('text.tick')].forEach(n=>n.remove());
  // æº–å‚™ 7 å¤©æ¡¶
  const now = new Date();
  const days = [...Array(7)].map((_,i)=>{
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()-6+i);
    const start = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
    const end   = start + 86400000;
    const mins = Math.round(rec7.filter(r=> r.date>=start && r.date<end).reduce((a,r)=>a+r.duration,0)/60);
    return {d, mins};
  });
  const max = Math.max(30, ...days.map(x=>x.mins));
  const W=320, H=140, padX=28, padY=22, innerW=W - padX*2, innerH=H - padY*2, bw=innerW/7 - 6;

  days.forEach((x,idx)=>{
    const h = Math.round((x.mins/max)*innerH);
    const xPos = padX + idx*(bw+6);
    const yPos = H - padY - h;
    const bar = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bar.setAttribute('class','bar');
    bar.setAttribute('x', xPos);
    bar.setAttribute('y', yPos);
    bar.setAttribute('width', bw);
    bar.setAttribute('height', h);
    bar.setAttribute('rx', 4);
    bar.setAttribute('fill', x.mins>=30 ? '#10b981' : '#f59e0b');
    svg.appendChild(bar);

    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('class','tick');
    t.setAttribute('x', xPos + bw/2);
    t.setAttribute('y', H-6);
    t.setAttribute('text-anchor','middle');
    t.setAttribute('font-size','10');
    t.setAttribute('fill','#94a3b8');
    t.textContent = `${x.d.getMonth()+1}/${x.d.getDate()}`;
    svg.appendChild(t);
  });
}

$('#clearAll').addEventListener('click', ()=>{
  if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼Ÿ')){
    State.records = []; saveRecords(); renderRecords();
  }
});

/* ========= å°ˆæ³¨ï¼ˆç•ªèŒ„ï¼‰ ========= */
const focusMin = $('#focusMin'), breakMin = $('#breakMin');
const fStart = $('#fStart'), fPause = $('#fPause'), fStop = $('#fStop');
let fTimer = null, fPhase='focus', fRemain=25*60;

function updateFocusUI(){
  $('#focusMinText').textContent = focusMin.value;
  $('#breakMinText').textContent = breakMin.value;
  $('#phaseTitle').textContent = fPhase==='focus'?'å°ˆæ³¨':'ä¼‘æ¯';
  $('#focusClock').textContent = secToClock(fRemain);
}
focusMin.addEventListener('input', ()=>{
  if(!fTimer){ fPhase='focus'; fRemain=focusMin.value*60; updateFocusUI(); }
});
breakMin.addEventListener('input', ()=>{
  if(!fTimer && fPhase==='break'){ fRemain=breakMin.value*60; updateFocusUI(); }
});

function fTick(){
  if(fRemain<=0){
    if(fPhase==='focus'){
      // å®Œæˆä¸€å€‹ç•ªèŒ„ï¼šè¨˜èƒ½é‡
      State.energy += 1; saveEnergy(); renderEnergy();
      showModal('å®Œæˆä¸€å€‹ç•ªèŒ„ï¼Œç²å¾— 1 èƒ½é‡ï¼');
      // åˆ‡åˆ°ä¼‘æ¯
      fPhase='break'; fRemain=breakMin.value*60;
    }else{
      // ä¼‘æ¯å®Œå›åˆ°å°ˆæ³¨
      fPhase='focus'; fRemain=focusMin.value*60;
    }
  }else{
    fRemain--; updateFocusUI();
  }
}

fStart.addEventListener('click', ()=>{
  if(fTimer) return;
  if(fRemain<=0){ fPhase='focus'; fRemain=focusMin.value*60; }
  fTimer = setInterval(fTick, 1000);
  fStart.disabled = true; fPause.disabled=false; fStop.disabled=false;
});
fPause.addEventListener('click', ()=>{
  if(!fTimer) return; clearInterval(fTimer); fTimer=null;
  fStart.disabled=false; fPause.disabled=true;
});
fStop.addEventListener('click', ()=>{
  if(fTimer){ clearInterval(fTimer); fTimer=null; }
  fPhase='focus'; fRemain=focusMin.value*60; updateFocusUI();
  fStart.disabled=false; fPause.disabled=true; fStop.disabled=true;
});
updateFocusUI();

/* ========= éŠæˆ²èƒ½é‡ ========= */
function renderEnergy(){ $('#energy').textContent = State.energy; }
renderEnergy();

$('#play2048').addEventListener('click', ()=>{
  if(State.energy<=0){ alert('èƒ½é‡ä¸è¶³ï¼Œå…ˆå®Œæˆä¸€æ¬¡è·‘æ­¥æˆ–ç•ªèŒ„å§ï¼'); return; }
  State.energy -= 1; saveEnergy(); renderEnergy();
  alert('å·²æ‰£ 1 èƒ½é‡ã€‚æ­¤è™•å¯è·³è½‰æˆ–åµŒå…¥ 2048 éŠæˆ²ç•«é¢ã€‚');
});

/* ========= åˆå§‹ç‹€æ…‹ ========= */
setTarget(30); updateControls(); updateRing(); renderRecords();
</script>
</body>
</html>
